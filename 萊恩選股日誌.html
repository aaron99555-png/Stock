<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠæ©é¸è‚¡æ—¥èªŒ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar - Dark Theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; /* slate-950 */
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; /* slate-700 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; /* slate-600 */
        }
        
        .compact-table th, .compact-table td {
            white-space: nowrap;
        }
        
        /* Modal transitions */
        .modal {
            transition: opacity 0.2s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Checkbox style override for Dark Mode */
        .custom-checkbox {
            appearance: none;
            background-color: transparent;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid currentColor;
            border-radius: 0.15em;
            display: grid;
            place-content: center;
        }

        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white; /* Checkmark color */
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        .custom-checkbox:checked {
            background-color: currentColor;
        }

        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        
        /* Input autofill fix for dark mode */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #020617 inset !important;
            -webkit-text-fill-color: white !important;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-sans pb-20 selection:bg-blue-500 selection:text-white">

    <!-- Tailwind Safelist for Dynamic Classes (Updated for Dark Mode) -->
    <div class="hidden">
        <div class="bg-red-900/40 text-red-300 border-red-700 ring-red-500/50"></div>
        <div class="bg-blue-900/40 text-blue-300 border-blue-700 ring-blue-500/50"></div>
        <div class="bg-purple-900/40 text-purple-300 border-purple-700 ring-purple-500/50"></div>
        <div class="bg-orange-900/40 text-orange-300 border-orange-700 ring-orange-500/50"></div>
        <!-- Pink for Wait Quarter -->
        <div class="bg-pink-900/40 text-pink-300 border-pink-700 ring-pink-500/50"></div>
        <!-- Green for Bearish Trend -->
        <div class="bg-green-900/40 text-green-300 border-green-700 ring-green-500/50"></div>
        
        <div class="text-red-400 text-blue-400 text-purple-400 text-orange-400 text-pink-400 text-green-400"></div>
        <div class="bg-red-500/20 bg-blue-500/20 bg-purple-500/20 bg-orange-500/20 bg-pink-500/20 bg-green-500/20"></div>
        <!-- Group hover colors for filters -->
        <div class="group-hover:text-red-400 group-hover:text-blue-400 group-hover:text-purple-400 group-hover:text-orange-400 group-hover:text-pink-400 group-hover:text-green-400"></div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 sticky top-0 z-30 shadow-lg shadow-black/20">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between gap-3">
            
            <div class="flex items-center gap-3 shrink-0">
                <div class="bg-blue-600 p-1.5 rounded-lg shadow-blue-500/20 shadow-[0_0_15px_rgba(37,99,235,0.3)]">
                    <i data-lucide="candlestick-chart" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white">èŠæ©é¸è‚¡æ—¥èªŒ</h1>
                    <p class="text-[10px] text-slate-500 font-mono hidden sm:block tracking-widest uppercase">Ryan's Stock Diary</p>
                </div>
                <!-- é¡¯ç¤ºé€£ç·šæ¨¡å¼ -->
                <span id="mode-badge" class="ml-2 text-[10px] bg-amber-900/30 text-amber-500 px-2 py-0.5 rounded border border-amber-700/50 hidden font-bold">LOCAL</span>
            </div>

            <!-- Date Picker -->
            <div class="flex items-center bg-slate-950 rounded-lg p-1 border border-slate-800 shadow-inner">
                <button id="prevDate" class="p-1.5 hover:bg-slate-800 rounded text-slate-500 hover:text-white transition-colors cursor-pointer">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>
                <div class="flex items-center gap-2 px-3 font-mono font-bold text-slate-200 text-sm">
                    <i data-lucide="calendar" class="w-3.5 h-3.5 text-blue-500"></i>
                    <input type="date" id="datePicker" class="bg-transparent border-none outline-none w-28 text-center cursor-pointer text-sm font-bold text-slate-200 [color-scheme:dark]">
                </div>
                <button id="nextDate" class="p-1.5 hover:bg-slate-800 rounded text-slate-500 hover:text-white transition-colors cursor-pointer">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="openDictModal" class="bg-slate-800 border border-slate-700 text-slate-400 hover:text-white hover:bg-slate-700 hover:border-slate-600 p-2 rounded-lg transition-all shadow-sm cursor-pointer active:scale-95 flex items-center gap-2" title="è³‡æ–™ç®¡ç†">
                    <i data-lucide="database" class="w-4 h-4"></i>
                    <span class="hidden sm:inline text-xs font-bold">è³‡æ–™ç®¡ç†</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        
        <!-- Summary Section -->
        <section class="bg-slate-900 rounded-xl shadow-lg border border-slate-800 overflow-hidden">
            <div class="p-4 border-b border-slate-800 bg-slate-900 flex justify-between items-center">
                <h2 class="text-base font-bold text-slate-100 flex items-center gap-2">
                    <i data-lucide="activity" class="w-5 h-5 text-blue-500"></i>
                    <span id="summaryTitle">è§€å¯Ÿå½™æ•´</span>
                </h2>
                <button id="copySummaryBtn" class="text-xs font-bold flex items-center gap-1.5 px-3 py-1.5 rounded-md transition-all shadow-sm border bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700 hover:text-white hover:border-slate-600 cursor-pointer active:scale-95">
                    <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                    <span id="copyBtnText">è¤‡è£½æ‘˜è¦</span>
                </button>
            </div>
            
            <div class="p-4 bg-slate-950/30">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-3">
                    <!-- Cards -->
                    <div class="bg-slate-900 rounded-lg p-3 border-l-4 border-red-600 shadow-md flex flex-col gap-2 ring-1 ring-white/5">
                        <div class="flex items-center gap-1.5 text-red-500 font-bold text-xs uppercase tracking-wide">
                            <i data-lucide="trending-up" class="w-3.5 h-3.5"></i> çªç ´æœˆç·š
                        </div>
                        <div id="summaryBreakMonth" class="flex flex-wrap gap-1.5 content-start min-h-[1.5rem]"><span class="text-slate-600 text-[10px]">-</span></div>
                    </div>
                    <div class="bg-slate-900 rounded-lg p-3 border-l-4 border-blue-600 shadow-md flex flex-col gap-2 ring-1 ring-white/5">
                        <div class="flex items-center gap-1.5 text-blue-500 font-bold text-xs uppercase tracking-wide">
                            <i data-lucide="activity" class="w-3.5 h-3.5"></i> çªç ´å­£ç·š
                        </div>
                        <div id="summaryBreakQuarter" class="flex flex-wrap gap-1.5 content-start min-h-[1.5rem]"><span class="text-slate-600 text-[10px]">-</span></div>
                    </div>
                    <div class="bg-slate-900 rounded-lg p-3 border-l-4 border-purple-600 shadow-md flex flex-col gap-2 ring-1 ring-white/5">
                        <div class="flex items-center gap-1.5 text-purple-500 font-bold text-xs uppercase tracking-wide">
                            <i data-lucide="git-merge" class="w-3.5 h-3.5"></i> å‡ç·šç³¾çµ
                        </div>
                        <div id="summaryMaEntangle" class="flex flex-wrap gap-1.5 content-start min-h-[1.5rem]"><span class="text-slate-600 text-[10px]">-</span></div>
                    </div>
                    <div class="bg-slate-900 rounded-lg p-3 border-l-4 border-orange-600 shadow-md flex flex-col gap-2 ring-1 ring-white/5">
                        <div class="flex items-center gap-1.5 text-orange-500 font-bold text-xs uppercase tracking-wide">
                            <i data-lucide="clock" class="w-3.5 h-3.5"></i> ç­‰å¾…æœˆç·š
                        </div>
                        <div id="summaryWaitBreakMonth" class="flex flex-wrap gap-1.5 content-start min-h-[1.5rem]"><span class="text-slate-600 text-[10px]">-</span></div>
                    </div>
                    <div class="bg-slate-900 rounded-lg p-3 border-l-4 border-pink-600 shadow-md flex flex-col gap-2 ring-1 ring-white/5">
                        <div class="flex items-center gap-1.5 text-pink-500 font-bold text-xs uppercase tracking-wide">
                            <i data-lucide="clock" class="w-3.5 h-3.5"></i> ç­‰å¾…å­£ç·š
                        </div>
                        <div id="summaryWaitBreakQuarter" class="flex flex-wrap gap-1.5 content-start min-h-[1.5rem]"><span class="text-slate-600 text-[10px]">-</span></div>
                    </div>
                    <!-- ç©ºæ–¹è¶¨å‹¢ -->
                    <div class="bg-slate-900 rounded-lg p-3 border-l-4 border-green-600 shadow-md flex flex-col gap-2 ring-1 ring-white/5">
                        <div class="flex items-center gap-1.5 text-green-500 font-bold text-xs uppercase tracking-wide">
                            <i data-lucide="trending-down" class="w-3.5 h-3.5"></i> ç©ºæ–¹è¶¨å‹¢
                        </div>
                        <div id="summaryBearishTrend" class="flex flex-wrap gap-1.5 content-start min-h-[1.5rem]"><span class="text-slate-600 text-[10px]">-</span></div>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Quick Add Section -->
            <section class="bg-slate-900 rounded-xl shadow-md border border-slate-800 overflow-hidden relative group">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-600 group-hover:w-1.5 transition-all"></div>
                <div class="p-4">
                    <h3 class="text-sm font-bold text-white mb-3 uppercase tracking-wider flex items-center gap-2">
                        <div class="p-1 bg-blue-500/10 rounded text-blue-500 border border-blue-500/20">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </div>
                        å–®ç­†æ–°å¢
                    </h3>
                    <form id="quickAddForm" class="flex flex-col gap-3">
                        <div class="grid grid-cols-5 gap-3">
                            <div class="col-span-2">
                                <input type="text" id="quickStockCode" class="w-full px-3 py-2 bg-slate-950 border border-slate-700 text-white rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm font-bold text-center placeholder-slate-600 transition-all" placeholder="ä»£è™Ÿ" autocomplete="off">
                            </div>
                            <div class="col-span-3">
                                <input type="text" id="quickStockName" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-800 text-slate-400 rounded-md text-sm font-medium" placeholder="åç¨± (è‡ªå‹•å¸¶å…¥)" readonly>
                                <input type="hidden" id="quickStockSector">
                            </div>
                        </div>
                        <div>
                            <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 mb-3">
                                <button type="button" class="quick-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="breakMonth" data-color="red">çªç ´æœˆç·š</button>
                                <button type="button" class="quick-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="breakQuarter" data-color="blue">çªç ´å­£ç·š</button>
                                <button type="button" class="quick-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="maEntangle" data-color="purple">å‡ç·šç³¾çµ</button>
                                <button type="button" class="quick-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="waitBreakMonth" data-color="orange">ç­‰å¾…æœˆç·š</button>
                                <button type="button" class="quick-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="waitBreakQuarter" data-color="pink">ç­‰å¾…å­£ç·š</button>
                                <button type="button" class="quick-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="bearishTrend" data-color="green">ç©ºæ–¹è¶¨å‹¢</button>
                            </div>
                            <button type="submit" id="quickAddBtn" disabled class="w-full px-4 py-2.5 bg-blue-700 hover:bg-blue-600 text-white rounded-md font-bold shadow-lg shadow-blue-900/20 disabled:opacity-50 disabled:cursor-not-allowed text-xs transition-all cursor-pointer flex items-center justify-center gap-2 active:scale-[0.98]">
                                <i data-lucide="check" class="w-4 h-4"></i> åŠ å…¥è§€å¯Ÿ (Enter)
                            </button>
                        </div>
                    </form>
                    <div id="quickNotFoundMsg" class="hidden text-xs text-red-400 font-bold mt-2 text-center bg-red-900/20 border border-red-900/50 py-1.5 rounded">âš ï¸ æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªä»£è™Ÿ</div>
                </div>
            </section>

            <!-- Batch Add Section -->
            <section class="bg-slate-900 rounded-xl shadow-md border border-slate-800 overflow-hidden relative group">
                <div class="absolute top-0 left-0 w-1 h-full bg-slate-600 group-hover:w-1.5 transition-all"></div>
                <div class="p-4">
                    <h3 class="text-sm font-bold text-white mb-3 uppercase tracking-wider flex items-center gap-2">
                        <div class="p-1 bg-slate-800 rounded text-slate-400 border border-slate-700">
                            <i data-lucide="layers" class="w-4 h-4"></i>
                        </div>
                        æ‰¹æ¬¡åŒ¯å…¥
                    </h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                            <button type="button" class="batch-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="breakMonth" data-color="red">çªç ´æœˆç·š</button>
                            <button type="button" class="batch-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="breakQuarter" data-color="blue">çªç ´å­£ç·š</button>
                            <button type="button" class="batch-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="maEntangle" data-color="purple">å‡ç·šç³¾çµ</button>
                            <button type="button" class="batch-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="waitBreakMonth" data-color="orange">ç­‰å¾…æœˆç·š</button>
                            <button type="button" class="batch-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="waitBreakQuarter" data-color="pink">ç­‰å¾…å­£ç·š</button>
                            <button type="button" class="batch-condition-btn text-[11px] font-bold px-2 py-2 rounded-md border bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300 transition-all cursor-pointer shadow-sm" data-key="bearishTrend" data-color="green">ç©ºæ–¹è¶¨å‹¢</button>
                        </div>
                        <div class="flex gap-2 items-stretch h-[42px]">
                            <textarea id="batchInput" class="flex-1 px-3 py-2 bg-slate-950 border border-slate-700 rounded-md text-xs focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none resize-none font-mono leading-normal placeholder:text-slate-600 placeholder:pt-0.5 text-slate-300" placeholder="è¼¸å…¥ä»£è™Ÿï¼Œä»¥ç©ºç™½åˆ†éš” (ä¾‹å¦‚: 2330 2317)"></textarea>
                            <button id="addBatchBtn" disabled class="px-5 bg-slate-700 hover:bg-slate-600 text-white rounded-md font-bold shadow-md disabled:opacity-50 disabled:cursor-not-allowed text-xs transition-all cursor-pointer whitespace-nowrap active:scale-95 flex items-center">
                                åŠ å…¥
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Column Selection & Table -->
        <section>
            <!-- Control Bar -->
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 shadow-md mb-4">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div class="flex items-center gap-3 w-full lg:w-auto overflow-x-auto pb-1 lg:pb-0 scrollbar-hide">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider shrink-0">ç¯©é¸æ¬„ä½:</div>
                        
                        <!-- å…¨é¸/å…¨å–æ¶ˆæŒ‰éˆ• -->
                        <div class="flex items-center gap-1 shrink-0">
                            <button id="btnSelectAll" class="text-[10px] px-2 py-1 bg-slate-800 text-slate-400 rounded border border-slate-700 hover:bg-slate-700 hover:text-white font-bold transition-colors">å…¨é¸</button>
                            <button id="btnSelectNone" class="text-[10px] px-2 py-1 bg-slate-800 text-slate-400 rounded border border-slate-700 hover:bg-slate-700 hover:text-white font-bold transition-colors">å–æ¶ˆ</button>
                        </div>
                        <div class="w-px h-5 bg-slate-700 mx-1 shrink-0"></div>

                        <div class="flex gap-4 shrink-0" id="columnFilters">
                            <label class="flex items-center gap-1.5 cursor-pointer group">
                                <input type="checkbox" value="breakMonth" class="custom-checkbox text-red-500" checked>
                                <span class="text-xs font-bold text-red-500 group-hover:text-red-400 transition-colors">çªç ´æœˆç·š</span>
                            </label>
                            <label class="flex items-center gap-1.5 cursor-pointer group">
                                <input type="checkbox" value="breakQuarter" class="custom-checkbox text-blue-500" checked>
                                <span class="text-xs font-bold text-blue-500 group-hover:text-blue-400 transition-colors">çªç ´å­£ç·š</span>
                            </label>
                            <label class="flex items-center gap-1.5 cursor-pointer group">
                                <input type="checkbox" value="maEntangle" class="custom-checkbox text-purple-500" checked>
                                <span class="text-xs font-bold text-purple-500 group-hover:text-purple-400 transition-colors">å‡ç·šç³¾çµ</span>
                            </label>
                            <label class="flex items-center gap-1.5 cursor-pointer group">
                                <input type="checkbox" value="waitBreakMonth" class="custom-checkbox text-orange-500" checked>
                                <span class="text-xs font-bold text-orange-500 group-hover:text-orange-400 transition-colors">ç­‰å¾…æœˆç·š</span>
                            </label>
                            <label class="flex items-center gap-1.5 cursor-pointer group">
                                <input type="checkbox" value="waitBreakQuarter" class="custom-checkbox text-pink-500" checked>
                                <span class="text-xs font-bold text-pink-500 group-hover:text-pink-400 transition-colors">ç­‰å¾…å­£ç·š</span>
                            </label>
                            <label class="flex items-center gap-1.5 cursor-pointer group">
                                <input type="checkbox" value="bearishTrend" class="custom-checkbox text-green-500" checked>
                                <span class="text-xs font-bold text-green-500 group-hover:text-green-400 transition-colors">ç©ºæ–¹è¶¨å‹¢</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Search -->
                    <div class="relative w-full lg:w-64 mt-2 lg:mt-0 shrink-0">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                        <input type="text" id="searchInput" placeholder="æœå°‹ä»£è™Ÿã€åç¨±ã€ç”¢æ¥­..." class="w-full pl-9 pr-3 py-2 bg-slate-950 border border-slate-700 rounded-lg text-sm text-slate-200 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none transition-all placeholder-slate-600">
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden bg-slate-900 border-2 border-dashed border-slate-800 rounded-xl p-12 text-center">
                <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="list-plus" class="w-8 h-8 text-slate-600"></i>
                </div>
                <p class="text-slate-400 font-bold text-base mb-1">ä»Šæ—¥å°šç„¡ç´€éŒ„</p>
                <p class="text-slate-600 text-xs mb-4">é–‹å§‹æ–°å¢æ‚¨é—œæ³¨çš„è‚¡ç¥¨å§ï¼</p>
                <button id="loadDefaultsBtn" class="text-blue-500 hover:text-blue-400 font-bold text-sm hover:underline cursor-pointer">
                    ğŸ“¥ è¼‰å…¥ç¯„ä¾‹è³‡æ–™
                </button>
            </div>

            <!-- Table Container -->
            <div id="tableContainer" class="bg-slate-900 border border-slate-800 rounded-xl shadow-lg overflow-hidden inline-block min-w-min max-w-full hidden flex flex-col">
                <div class="p-4 border-b border-slate-800 bg-slate-900 flex items-center justify-between gap-2 shrink-0">
                    <div class="flex items-center gap-2 text-white">
                        <i data-lucide="table" class="w-4 h-4 text-blue-500"></i>
                        <h3 class="text-sm font-bold"><span id="tableTitleDate"></span> å³æ™‚è§€å¯Ÿæ¸…å–®</h3>
                        <span id="stockCount" class="text-xs text-slate-500 font-mono"></span>
                    </div>
                    <!-- æ’åºæŒ‰éˆ• -->
                    <button id="toggleSortBtn" class="flex items-center gap-1 text-[11px] font-bold text-slate-400 hover:text-white px-2 py-1 rounded hover:bg-slate-800 transition-colors" title="åˆ‡æ›æ’åº">
                        <i data-lucide="arrow-up-down" class="w-3 h-3"></i>
                        <span id="sortLabel">æŒ‰ä»£è™Ÿ</span>
                    </button>
                </div>
                <div class="overflow-x-auto overflow-y-auto max-h-[600px]">
                    <table class="w-auto text-left border-collapse whitespace-nowrap compact-table">
                        <thead id="tableHead" class="sticky top-0 z-20 shadow-md">
                            <!-- Headers injected by JS -->
                        </thead>
                        <tbody id="stockTableBody" class="divide-y divide-slate-800/50 bg-slate-900">
                            <!-- Rows inserted by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-900 rounded-xl shadow-2xl border border-slate-800 w-full max-w-xs overflow-hidden p-6 text-center transform transition-all">
            <div class="w-12 h-12 rounded-full bg-red-900/30 flex items-center justify-center mx-auto mb-4 ring-8 ring-red-900/10">
                <i data-lucide="trash-2" class="w-6 h-6 text-red-500"></i>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">ç¢ºå®šåˆªé™¤?</h3>
            <p class="text-sm text-slate-400 mb-6 leading-relaxed">æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦å¾æ¸…å–®ä¸­ç§»é™¤é€™æª”è‚¡ç¥¨å—ï¼Ÿ</p>
            <div class="flex gap-3 justify-center">
                <button class="close-modal px-4 py-2 bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg font-bold text-sm transition-colors cursor-pointer w-full">å–æ¶ˆ</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white hover:bg-red-500 rounded-lg font-bold text-sm transition-colors shadow-md cursor-pointer w-full flex items-center justify-center gap-2">
                    ç¢ºèª
                </button>
            </div>
        </div>
    </div>

    <!-- Dictionary Modal -->
    <div id="dictModal" class="modal fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-900 rounded-xl shadow-2xl border border-slate-800 w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-800 flex justify-between items-center bg-slate-900">
                <h3 class="text-base font-bold text-white flex items-center gap-2">
                    <i data-lucide="database" class="w-4 h-4 text-blue-500"></i>
                    ç®¡ç†è‚¡ç¥¨æ¸…å–®
                </h3>
                <button class="close-modal cursor-pointer p-1 rounded hover:bg-slate-800 text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <!-- Config Warning (New) -->
                <div id="configWarning" class="bg-amber-900/20 border border-amber-800/50 rounded-lg p-4 mb-4 hidden">
                    <p class="text-xs font-bold text-amber-500 mb-1">æ³¨æ„ï¼šFirebase è¨­å®š</p>
                    <p class="text-xs text-amber-300/80 leading-relaxed">
                        æ‚¨å·²åˆ‡æ›ç‚ºæœ¬åœ°æ¨¡å¼ã€‚è‹¥è¦é€£ç·šåˆ°æ‚¨çš„ Firebase (<code>stock-6c6ad...</code>)ï¼Œè«‹ä¸‹è¼‰æª”æ¡ˆä¸¦å¡«å…¥æ‚¨çš„ Firebase Configã€‚
                    </p>
                </div>

                <div class="bg-blue-900/20 border border-blue-800/50 rounded-lg p-4 mb-4">
                    <p class="text-xs font-bold text-blue-400 mb-1 flex items-center gap-1.5">
                        <i data-lucide="info" class="w-3.5 h-3.5"></i>
                        ç³»çµ±å…§å»ºè³‡æ–™åº«
                    </p>
                    <p class="text-xs text-blue-300/80 leading-relaxed">
                        ç³»çµ±å·²å…§å»ºç´„ 1300 æª”å¸¸ç”¨å€‹è‚¡è³‡æ–™ã€‚æ‚¨åªéœ€åœ¨æ–°å¢æ™‚è¼¸å…¥ä»£è™Ÿå³å¯è‡ªå‹•å¸¶å‡ºåç¨±èˆ‡ç”¢æ¥­ã€‚ä¸‹æ–¹å¯é¡å¤–æ“´å……æ‚¨çš„è‡ªå®šç¾©æ¸…å–®ã€‚
                    </p>
                </div>
                <div class="space-y-6">
                     <!-- Backup/Restore -->
                    <div class="bg-indigo-900/20 p-4 rounded-lg border border-indigo-800/50">
                        <h4 class="text-xs font-bold text-indigo-400 mb-2 flex items-center gap-2">
                            <i data-lucide="save" class="w-3.5 h-3.5"></i> å‚™ä»½èˆ‡é‚„åŸ
                        </h4>
                        <div class="flex gap-2">
                            <button onclick="window.exportData()" class="flex-1 px-3 py-1.5 bg-slate-800 border border-indigo-500/30 text-indigo-300 rounded text-xs font-bold hover:bg-slate-700 hover:text-indigo-200 transition-colors flex items-center justify-center gap-1">
                                <i data-lucide="download" class="w-3 h-3"></i> åŒ¯å‡º JSON
                            </button>
                            <button onclick="document.getElementById('importFile').click()" class="flex-1 px-3 py-1.5 bg-indigo-600 text-white rounded text-xs font-bold hover:bg-indigo-500 transition-colors flex items-center justify-center gap-1">
                                <i data-lucide="upload" class="w-3 h-3"></i> åŒ¯å…¥ JSON
                            </button>
                            <input type="file" id="importFile" class="hidden" accept=".json" onchange="window.importData(this)">
                        </div>
                    </div>
                    
                    <!-- Dictionary Input -->
                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <label class="text-xs font-bold text-slate-400">æ“´å……æ¸…å–® (Excel è²¼ä¸Š)</label>
                            <span id="dictPreviewBadge" class="text-[10px] font-bold text-blue-400 bg-blue-900/30 px-2 py-0.5 rounded-full border border-blue-800">
                                é è¦½ï¼š0 ç­†
                            </span>
                        </div>
                        <textarea id="dictInput" class="w-full h-32 border border-slate-700 bg-slate-950 rounded-lg p-3 font-mono text-xs focus:ring-2 focus:ring-blue-600 focus:border-blue-600 outline-none whitespace-pre leading-relaxed text-slate-300 placeholder-slate-600" placeholder="æ ¼å¼: ä»£è™Ÿ åç¨± ç”¢æ¥­&#10;2330 å°ç©é›» åŠå°é«”&#10;2317 é´»æµ· å…¶ä»–é›»å­"></textarea>
                        <div class="flex justify-between items-center mt-2">
                             <span id="dbCountDisplay" class="text-[10px] text-slate-500">è‡ªå®šç¾©è³‡æ–™åº«ï¼š0 ç­†</span>
                             <button id="saveDictBtn" disabled class="px-4 py-1.5 bg-slate-800 hover:bg-slate-700 text-white rounded text-xs font-bold disabled:opacity-50 transition-all shadow-sm">
                                æ›´æ–°è³‡æ–™åº«
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ä½¿ç”¨è€…è‡ªå®šç¾©è¨­å®š (ä¸‹è¼‰å¾Œè«‹å¡«å…¥é€™è£¡) ---
        // è‹¥è¦ä½¿ç”¨æ‚¨è‡ªå·±çš„ Firebaseï¼Œè«‹å–æ¶ˆä¸‹æ–¹è¨»è§£ä¸¦å¡«å…¥æ‚¨çš„ Config
        // const USER_FIREBASE_CONFIG = {
        //    apiKey: "YOUR_API_KEY",
        //    authDomain: "stock-6c6ad.firebaseapp.com",
        //    projectId: "stock-6c6ad",
        //    storageBucket: "stock-6c6ad.appspot.com",
        //    messagingSenderId: "...",
        //    appId: "..."
        // };

        // Global Variables
        let user = null;
        let stocks = [];
        let userDictionary = {};
        let stockToDeleteId = null; 
        let selectedDate = new Date().toISOString().slice(0, 10);
        let sortMethod = 'code'; 
        let useLocalMode = false;
        let db = null;
        let appId = 'default-app-id';

        const getLocalISODate = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d - offset).toISOString().slice(0, 10);
        };
        selectedDate = getLocalISODate();

        // --- Data Import ---
        const RAW_STOCK_DATA = `1101	å°æ³¥	æ°´æ³¥
1102	äºæ³¥	æ°´æ³¥
1216	çµ±ä¸€	é£Ÿå“
2330	å°ç©é›»	åŠå°é«”
2317	é´»æµ·	å…¶ä»–é›»å­
2454	è¯ç™¼ç§‘	åŠå°é«”
2303	è¯é›»	åŠå°é«”
2881	å¯Œé‚¦é‡‘	é‡‘èä¿éšª
2882	åœ‹æ³°é‡‘	é‡‘èä¿éšª
1301	å°å¡‘	å¡‘è† 
1303	å—äº	å¡‘è† 
2002	ä¸­é‹¼	é‹¼éµ
2603	é•·æ¦®	èˆªé‹
2609	é™½æ˜	èˆªé‹
2615	è¬æµ·	èˆªé‹
912000	æ™¨è¨Šç§‘-DR	å­˜è¨—æ†‘è­‰`;

        const BUILTIN_STOCKS = {};
        
        RAW_STOCK_DATA.trim().split('\n').forEach(line => {
            const parts = line.trim().split(/[ \t]+/); 
            if (parts.length >= 2) {
                const code = parts[0];
                const name = parts[1];
                const sector = parts.length > 2 ? parts[2] : '';
                BUILTIN_STOCKS[code] = { name, sector };
            }
        });

        const DEFAULT_STOCKS = [
            { code: '2330', name: 'å°ç©é›»', sector: 'åŠå°é«”' },
            { code: '2317', name: 'é´»æµ·', sector: 'å…¶ä»–é›»å­' },
            { code: '2454', name: 'è¯ç™¼ç§‘', sector: 'åŠå°é«”' }
        ];

        async function initApp() {
            try {
                // Priority: User Config > Env Config > Local Mode
                let configToUse = null;
                
                if (typeof USER_FIREBASE_CONFIG !== 'undefined') {
                    configToUse = USER_FIREBASE_CONFIG;
                } else if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') {
                    configToUse = JSON.parse(__firebase_config);
                }

                if (configToUse) {
                    const app = initializeApp(configToUse);
                    const auth = getAuth(app);
                    db = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (currentUser) => {
                        user = currentUser;
                        if (user) initDataListeners();
                    });
                } else {
                    throw new Error("No Valid Firebase Config");
                }
            } catch (e) {
                console.warn("Initializing Local Mode:", e);
                useLocalMode = true;
                user = { uid: 'local_user' };
                document.getElementById('mode-badge').classList.remove('hidden');
                document.getElementById('configWarning').classList.remove('hidden'); // Show hint in modal
                initDataListeners();
            }
        }
        initApp();

        function initDataListeners() {
            if (!useLocalMode) {
                const stocksQuery = query(collection(db, 'artifacts', appId, 'users', user.uid, 'stocks'));
                onSnapshot(stocksQuery, (snapshot) => {
                    stocks = snapshot.docs.map(doc => {
                        const data = doc.data();
                        let dateStr = data.dateStr || getLocalISODate(); 
                        return { id: doc.id, ...data, dateStr };
                    });
                    renderApp();
                });

                const dictQuery = query(collection(db, 'artifacts', appId, 'users', user.uid, 'stockDictionary'));
                onSnapshot(dictQuery, (snapshot) => {
                    userDictionary = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.code) userDictionary[data.code] = { name: data.name, sector: data.sector };
                    });
                    updateDictCount();
                });
            } else {
                loadLocalStocks();
                loadLocalDict();
            }
        }

        function loadLocalStocks() {
            const data = localStorage.getItem('stock_diary_data');
            if (data) {
                stocks = JSON.parse(data);
            } else {
                stocks = [];
            }
            renderApp();
        }

        function saveLocalStocks() {
            localStorage.setItem('stock_diary_data', JSON.stringify(stocks));
            renderApp();
        }

        function loadLocalDict() {
            const data = localStorage.getItem('stock_diary_dict');
            if (data) userDictionary = JSON.parse(data);
            updateDictCount();
        }

        function saveLocalDict() {
            localStorage.setItem('stock_diary_dict', JSON.stringify(userDictionary));
            updateDictCount();
        }

        async function saveStockData(stockId, payload, isMerge = true) {
            if (!useLocalMode) {
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stocks', stockId), payload, { merge: isMerge });
            } else {
                const existingIndex = stocks.findIndex(s => s.id === stockId);
                if (existingIndex >= 0 && isMerge) {
                    stocks[existingIndex] = { ...stocks[existingIndex], ...payload };
                } else if (existingIndex >= 0 && !isMerge) {
                    stocks[existingIndex] = { id: stockId, ...payload };
                } else {
                    stocks.push({ id: stockId, ...payload });
                }
                saveLocalStocks();
            }
        }

        async function removeStockData(stockId) {
            if (!useLocalMode) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stocks', stockId));
            } else {
                stocks = stocks.filter(s => s.id !== stockId);
                saveLocalStocks();
            }
        }

        function renderApp() {
            updateDateDisplay();
            renderTable();
            renderSummary();
        }

        function updateDateDisplay() {
            const datePicker = document.getElementById('datePicker');
            const summaryTitle = document.getElementById('summaryTitle');
            const tableTitleDate = document.getElementById('tableTitleDate');
            
            if (datePicker) datePicker.value = selectedDate;
            
            const [y, m, d] = selectedDate.split('-');
            const display = `${y}/${m}/${d}`;
            
            if (summaryTitle) summaryTitle.textContent = `${display} è§€å¯Ÿå½™æ•´`;
            if (tableTitleDate) tableTitleDate.textContent = display;
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${m}/${d}`;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let icon = '';
            let bgClass = '';
            
            if (type === 'success') {
                icon = `<i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>`;
                bgClass = 'bg-slate-800 border-slate-700 text-slate-100 shadow-emerald-900/20';
            } else if (type === 'error') {
                icon = `<i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>`;
                bgClass = 'bg-slate-800 border-slate-700 text-slate-100 shadow-red-900/20';
            } else {
                icon = `<i data-lucide="info" class="w-5 h-5 text-blue-400"></i>`;
                bgClass = 'bg-slate-800 border-slate-700 text-slate-100 shadow-blue-900/20';
            }
            
            toast.className = `flex items-center gap-3 px-4 py-3 rounded-lg shadow-xl border ${bgClass} toast-enter min-w-[280px]`;
            toast.innerHTML = `
                ${icon}
                <div class="text-sm font-bold">${message}</div>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        const COLUMN_CONFIG = {
            breakMonth: { label: 'çªç ´æœˆç·š', color: 'red', icon: 'trending-up' },
            breakQuarter: { label: 'çªç ´å­£ç·š', color: 'blue', icon: 'activity' },
            maEntangle: { label: 'å‡ç·šç³¾çµ', color: 'purple', icon: 'git-merge' },
            waitBreakMonth: { label: 'ç­‰å¾…æœˆç·š', color: 'orange', icon: 'clock' },
            waitBreakQuarter: { label: 'ç­‰å¾…å­£ç·š', color: 'pink', icon: 'clock' },
            bearishTrend: { label: 'ç©ºæ–¹è¶¨å‹¢', color: 'green', icon: 'trending-down' }
        };

        function renderTable() {
            const currentDayStocks = stocks.filter(s => s.dateStr === selectedDate);
            const searchInput = document.getElementById('searchInput');
            
            if (sortMethod === 'code') {
                currentDayStocks.sort((a, b) => a.code.localeCompare(b.code));
                document.getElementById('sortLabel').textContent = 'æŒ‰ä»£è™Ÿ';
            } else {
                const getTime = (item) => {
                     if (item.createdAt && item.createdAt.seconds) return item.createdAt.seconds; 
                     return new Date(item.createdAt).getTime() || 0;
                };
                currentDayStocks.sort((a, b) => getTime(b) - getTime(a));
                document.getElementById('sortLabel').textContent = 'æŒ‰æ™‚é–“';
            }

            if(!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            
            const activeColumns = [];
            document.querySelectorAll('#columnFilters input:checked').forEach(cb => {
                activeColumns.push(cb.value);
            });

            const filtered = currentDayStocks.filter(s => {
                const matchSearch = s.code.includes(searchTerm) || 
                                  s.name.toLowerCase().includes(searchTerm) ||
                                  (s.sector && s.sector.includes(searchTerm));
                
                if (!matchSearch) return false;
                if (activeColumns.length === 0) return false;
                return activeColumns.some(key => s[key] === true);
            });

            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('stockTableBody');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.getElementById('tableContainer');
            const countEl = document.getElementById('stockCount');

            if(countEl) countEl.textContent = `(${filtered.length})`;

            if (currentDayStocks.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
                if(tableContainer) tableContainer.classList.add('hidden');
            } else {
                if(emptyState) emptyState.classList.add('hidden');
                if(tableContainer) tableContainer.classList.remove('hidden');
            }

            if(!thead || !tbody) return;

            // Dark Theme Header
            let headerHTML = `
                <tr class="bg-slate-800 text-xs font-bold text-slate-300 uppercase">
                    <th class="px-3 py-3 border-r border-slate-700 w-14 bg-slate-800 sticky top-0 z-10">æ—¥æœŸ</th>
                    <th class="px-3 py-3 border-r border-slate-700 w-16 bg-slate-800 sticky top-0 z-10">ä»£è™Ÿ</th>
                    <th class="px-4 py-3 border-r border-slate-700 w-24 bg-slate-800 sticky top-0 z-10">åç¨±</th>
                    <th class="px-3 py-3 border-r border-slate-700 text-slate-400 font-medium w-20 bg-slate-800 sticky top-0 z-10">ç”¢æ¥­</th>
            `;
            
            activeColumns.forEach(key => {
                const conf = COLUMN_CONFIG[key];
                headerHTML += `
                    <th class="px-2 py-3 text-center bg-slate-800 border-r border-slate-700 w-16 sticky top-0 z-10">
                        <span class="text-${conf.color}-400 text-[11px]">${conf.label}</span>
                    </th>
                `;
            });
            
            headerHTML += `<th class="px-1 py-3 text-center w-10 bg-slate-800 sticky top-0 z-10"></th></tr>`;
            thead.innerHTML = headerHTML;

            tbody.innerHTML = '';
            filtered.forEach(stock => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-800/50 group transition-colors border-b border-slate-800 last:border-0';
                
                let rowHTML = `
                    <td class="px-3 py-2 font-mono text-slate-500 text-xs border-r border-slate-800 group-hover:border-slate-700 transition-colors">${formatDateShort(stock.dateStr)}</td>
                    <td class="px-3 py-2 font-mono font-bold text-slate-300 text-sm border-r border-slate-800 group-hover:border-slate-700 transition-colors">
                        <a href="https://tw.stock.yahoo.com/quote/${stock.code}" target="_blank" class="hover:text-blue-400 hover:underline decoration-blue-500/50 underline-offset-4">${stock.code}</a>
                    </td>
                    <td class="px-4 py-2 font-bold text-white text-sm border-r border-slate-800 group-hover:border-slate-700 transition-colors">
                        <a href="https://tw.stock.yahoo.com/quote/${stock.code}" target="_blank" class="hover:text-blue-400 transition-colors">${stock.name}</a>
                    </td>
                    <td class="px-3 py-2 text-slate-400 text-xs border-r border-slate-800 group-hover:border-slate-700 transition-colors">
                        ${stock.sector ? `<span class="bg-slate-800 text-slate-400 border border-slate-700 px-2 py-0.5 rounded text-[11px] font-medium">${stock.sector}</span>` : '-'}
                    </td>
                `;

                activeColumns.forEach(key => {
                    const conf = COLUMN_CONFIG[key];
                    const isChecked = stock[key];
                    const iconName = conf.icon; 
                    
                    rowHTML += `
                        <td class="px-2 py-0 border-r border-slate-800 group-hover:border-slate-700 transition-colors ${isChecked ? `bg-${conf.color}-900/10` : ''}">
                            <div onclick="toggleCondition('${stock.id}', '${key}')" class="flex justify-center items-center h-10 cursor-pointer hover:bg-slate-800 transition-colors">
                                ${isChecked ? 
                                    `<div class="w-6 h-6 rounded-full bg-${conf.color}-900/50 border border-${conf.color}-700 flex items-center justify-center shadow-[0_0_10px_rgba(0,0,0,0.2)]"><i data-lucide="${iconName}" class="w-3.5 h-3.5 text-${conf.color}-400"></i></div>` : 
                                    `<div class="w-1.5 h-1.5 rounded-full bg-slate-800"></div>`
                                }
                            </div>
                        </td>
                    `;
                });

                rowHTML += `
                    <td class="px-1 py-2 text-center">
                        <button onclick="event.stopPropagation(); window.confirmDeleteStock('${stock.id}')" class="text-slate-600 hover:text-red-400 p-1.5 rounded-full hover:bg-red-900/20 transition-colors opacity-0 group-hover:opacity-100 cursor-pointer" title="åˆªé™¤">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                
                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        document.querySelectorAll('#columnFilters input').forEach(input => {
            input.addEventListener('change', renderTable);
        });

        document.getElementById('btnSelectAll').addEventListener('click', () => {
            document.querySelectorAll('#columnFilters input').forEach(cb => cb.checked = true);
            renderTable();
        });
        document.getElementById('btnSelectNone').addEventListener('click', () => {
            document.querySelectorAll('#columnFilters input').forEach(cb => cb.checked = false);
            renderTable();
        });

        document.getElementById('toggleSortBtn').addEventListener('click', () => {
            sortMethod = sortMethod === 'code' ? 'time' : 'code';
            renderTable();
        });

        function renderSummary() {
            const currentDayStocks = stocks.filter(s => s.dateStr === selectedDate);
            
            const createBadges = (items, color) => {
                if (items.length === 0) return `<span class="text-slate-700 text-[10px] py-0.5">--</span>`;
                return items.map(s => 
                    `<span class="bg-${color}-900/30 text-${color}-300 px-1.5 py-0.5 rounded text-[10px] border border-${color}-800 font-bold hover:bg-${color}-900/50 transition-colors cursor-default">${s.code} ${s.name}</span>`
                ).join('');
            };

            const ids = {
                'summaryBreakMonth': 'breakMonth',
                'summaryBreakQuarter': 'breakQuarter',
                'summaryMaEntangle': 'maEntangle',
                'summaryWaitBreakMonth': 'waitBreakMonth',
                'summaryWaitBreakQuarter': 'waitBreakQuarter',
                'summaryBearishTrend': 'bearishTrend'
            };
            const colors = {
                'breakMonth': 'red',
                'breakQuarter': 'blue',
                'maEntangle': 'purple',
                'waitBreakMonth': 'orange',
                'waitBreakQuarter': 'pink',
                'bearishTrend': 'green'
            };

            for (const [id, key] of Object.entries(ids)) {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = createBadges(currentDayStocks.filter(s => s[key]), colors[key]);
                }
            }
        }

        window.toggleCondition = async (id, field) => {
            if (!user) return;
            const s = stocks.find(s => s.id === id);
            if (!s) return;
            const payload = { [field]: !s[field] };
            await saveStockData(id, payload, true);
        };

        window.confirmDeleteStock = (id) => {
            stockToDeleteId = id;
            toggleModal('deleteConfirmModal', true);
        };

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!user || !stockToDeleteId) return;
            try {
                await removeStockData(stockToDeleteId);
                toggleModal('deleteConfirmModal', false);
                stockToDeleteId = null;
                showToast('å·²åˆªé™¤è‚¡ç¥¨', 'success');
            } catch (err) {
                console.error("Delete failed", err);
                showToast("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
            }
        });

        document.getElementById('datePicker').addEventListener('change', (e) => {
            selectedDate = e.target.value;
            renderApp();
        });
        document.getElementById('prevDate').addEventListener('click', () => changeDate(-1));
        document.getElementById('nextDate').addEventListener('click', () => changeDate(1));

        function changeDate(offset) {
            const d = new Date(selectedDate);
            d.setDate(d.getDate() + offset);
            const offsetTime = d.getTimezoneOffset() * 60000;
            selectedDate = new Date(d.getTime() - offsetTime).toISOString().slice(0, 10);
            renderApp();
        }

        document.getElementById('searchInput').addEventListener('input', renderTable);

        document.getElementById('loadDefaultsBtn').addEventListener('click', async () => {
            if (!user) { showToast('è«‹ç¨å€™ï¼Œè³‡æ–™åº«é€£ç·šä¸­...', 'info'); return; }
            
            if (useLocalMode) {
                 DEFAULT_STOCKS.forEach(stock => {
                    const stockId = `${selectedDate}-${stock.code}`;
                    const payload = {
                        ...stock,
                        dateStr: selectedDate,
                        breakMonth: false,
                        breakQuarter: false,
                        maEntangle: false,
                        waitBreakMonth: false,
                        waitBreakQuarter: false,
                        bearishTrend: false,
                        createdAt: new Date().toISOString()
                    };
                    saveStockData(stockId, payload, true);
                });
                showToast('å·²è¼‰å…¥ç¯„ä¾‹æ¸…å–® (Local)', 'success');
                return;
            }

            const batch = writeBatch(db);
            DEFAULT_STOCKS.forEach(stock => {
                const stockId = `${selectedDate}-${stock.code}`;
                const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'stocks', stockId);
                batch.set(ref, {
                    ...stock,
                    dateStr: selectedDate,
                    breakMonth: false,
                    breakQuarter: false,
                    maEntangle: false,
                    waitBreakMonth: false,
                    waitBreakQuarter: false,
                    bearishTrend: false,
                    createdAt: serverTimestamp()
                }, { merge: true });
            });
            await batch.commit();
            showToast('å·²è¼‰å…¥ç¯„ä¾‹æ¸…å–®', 'success');
        });

        document.getElementById('copySummaryBtn').addEventListener('click', () => {
            const currentDayStocks = stocks.filter(s => s.dateStr === selectedDate);
            const [y, m, d] = selectedDate.split('-');
            let summary = `ã€${y}/${m}/${d} å³æ™‚æŠ€è¡“é¢è§€å¯Ÿã€‘\n`;

            const bm = currentDayStocks.filter(s => s.breakMonth);
            const bq = currentDayStocks.filter(s => s.breakQuarter);
            const ma = currentDayStocks.filter(s => s.maEntangle);
            const wm = currentDayStocks.filter(s => s.waitBreakMonth);
            const wq = currentDayStocks.filter(s => s.waitBreakQuarter);
            const bt = currentDayStocks.filter(s => s.bearishTrend);

            if (bm.length) summary += `\nğŸ“ˆ çªç ´æœˆç·š:\n${bm.map(s => `${s.code} ${s.name}`).join('ã€')}\n`;
            if (bq.length) summary += `\nğŸš€ çªç ´å­£ç·š:\n${bq.map(s => `${s.code} ${s.name}`).join('ã€')}\n`;
            if (ma.length) summary += `\nğŸŒ€ å‡ç·šç³¾çµçªç ´:\n${ma.map(s => `${s.code} ${s.name}`).join('ã€')}\n`;
            if (wm.length) summary += `\nâ° ç­‰å¾…æœˆç·š:\n${wm.map(s => `${s.code} ${s.name}`).join('ã€')}\n`;
            if (wq.length) summary += `\nâ° ç­‰å¾…å­£ç·š:\n${wq.map(s => `${s.code} ${s.name}`).join('ã€')}\n`;
            if (bt.length) summary += `\nğŸ“‰ ç©ºæ–¹è¶¨å‹¢:\n${bt.map(s => `${s.code} ${s.name}`).join('ã€')}\n`;
            
            if (!bm.length && !bq.length && !ma.length && !wm.length && !wq.length && !bt.length) summary += "\nä»Šæ—¥å°šç„¡ç¬¦åˆæ¢ä»¶çš„è§€å¯Ÿè‚¡ã€‚";

            const textarea = document.createElement('textarea');
            textarea.value = summary;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            showToast("å·²è¤‡è£½æ‘˜è¦ï¼", "success");
        });

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if (show) {
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('active'), 10);
            } else {
                el.classList.remove('active');
                setTimeout(() => el.classList.add('hidden'), 200);
            }
        }

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                toggleModal(modal.id, false);
            });
        });

        const getStockInfo = (code) => {
            return userDictionary[code] || BUILTIN_STOCKS[code] || { name: '', sector: '' };
        };

        const quickConditions = { breakMonth: false, breakQuarter: false, maEntangle: false, waitBreakMonth: false, waitBreakQuarter: false, bearishTrend: false };

        document.getElementById('quickStockCode').addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('quickAddBtn').disabled = !val;
            
            const info = getStockInfo(val);
            if (info.name) {
                document.getElementById('quickStockName').value = info.name;
                document.getElementById('quickStockSector').value = info.sector || '';
                document.getElementById('quickNotFoundMsg').classList.add('hidden');
            } else {
                document.getElementById('quickStockName').value = '';
                document.getElementById('quickStockSector').value = '';
                if (val.length >= 4) document.getElementById('quickNotFoundMsg').classList.remove('hidden');
                else document.getElementById('quickNotFoundMsg').classList.add('hidden');
            }
        });
        
        document.getElementById('quickStockCode').addEventListener('keydown', (e) => {
             if (e.key === 'Enter') {
                e.preventDefault(); 
                if (!document.getElementById('quickAddBtn').disabled) {
                    document.getElementById('quickAddBtn').click();
                }
             }
        });

        document.querySelectorAll('.quick-condition-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const key = btn.dataset.key;
                quickConditions[key] = !quickConditions[key];
                updateBtnState(btn, quickConditions[key], 'quick');
            });
        });

        document.getElementById('quickAddForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!user) { showToast('è«‹ç¨å€™ï¼Œè³‡æ–™åº«é€£ç·šä¸­...', 'info'); return; }
            
            const code = document.getElementById('quickStockCode').value;
            let name = document.getElementById('quickStockName').value;
            let sector = document.getElementById('quickStockSector').value;
            
            if (!code) return;
            if (!name) name = code;

            const stockId = `${selectedDate}-${code}`;
            const payload = {
                code, name, sector, dateStr: selectedDate,
                createdAt: useLocalMode ? new Date().toISOString() : serverTimestamp()
            };
            for (const [key, value] of Object.entries(quickConditions)) {
                if (value) payload[key] = true;
            }

            try {
                await saveStockData(stockId, payload, true);
                
                document.getElementById('quickStockCode').value = '';
                document.getElementById('quickStockName').value = '';
                document.getElementById('quickStockSector').value = '';
                document.getElementById('quickAddBtn').disabled = true;
                
                // NO RESET
                
                showToast(`å·²æ–°å¢ ${name}`, 'success');
                document.getElementById('quickStockCode').focus();

            } catch (err) {
                console.error(err);
                showToast('æ–°å¢å¤±æ•—', 'error');
            }
        });

        const batchConditions = { breakMonth: false, breakQuarter: false, maEntangle: false, waitBreakMonth: false, waitBreakQuarter: false, bearishTrend: false };
        
        document.querySelectorAll('.batch-condition-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const key = btn.dataset.key;
                batchConditions[key] = !batchConditions[key];
                updateBtnState(btn, batchConditions[key], 'batch');
            });
        });

        function updateBtnState(btn, active, type) {
            const color = btn.dataset.color;
            const idClass = type === 'quick' ? 'quick-condition-btn' : 'batch-condition-btn';
            const baseClass = `${idClass} text-[11px] font-bold px-3 py-2 rounded-md border transition-all cursor-pointer flex-1 shadow-sm`;
            
            if (active) {
                btn.className = `${baseClass} bg-${color}-900/40 text-${color}-300 border-${color}-700 ring-2 ring-${color}-500/50 ring-offset-1 ring-offset-slate-900`;
            } else {
                btn.className = `${baseClass} bg-slate-800 text-slate-500 border-slate-700 hover:bg-slate-700 hover:text-slate-300`;
            }
        }

        document.getElementById('batchInput').addEventListener('input', (e) => {
            document.getElementById('addBatchBtn').disabled = !e.target.value.trim();
        });

        document.getElementById('addBatchBtn').addEventListener('click', async () => {
            if (!user) { showToast('è«‹ç¨å€™ï¼Œè³‡æ–™åº«é€£ç·šä¸­...', 'info'); return; }
            const input = document.getElementById('batchInput').value;
            if (!input.trim()) return;

            const lines = input.split(/[\n, ]+/).map(l => l.trim()).filter(l => l);
            
            const resetUI = (count) => {
                document.getElementById('batchInput').value = '';
                document.getElementById('addBatchBtn').disabled = true;
                
                ['breakMonth', 'breakQuarter', 'maEntangle', 'waitBreakMonth', 'waitBreakQuarter', 'bearishTrend'].forEach(k => {
                    batchConditions[k] = false;
                });
                document.querySelectorAll('.batch-condition-btn').forEach(btn => {
                    updateBtnState(btn, false, 'batch');
                });
                showToast(`å·²æ‰¹æ¬¡æ–°å¢ ${count} ç­†`, 'success');
            };

            if (useLocalMode) {
                 let count = 0;
                 for (const codeRaw of lines) {
                    const match = codeRaw.match(/^(\d{3,6})/); 
                    const code = match ? match[1] : codeRaw;
                    
                    if (code) {
                        let name = code;
                        let sector = '';
                        const info = getStockInfo(code);
                        if (info.name) {
                            name = info.name;
                            sector = info.sector || '';
                        }

                        const stockId = `${selectedDate}-${code}`;
                        const payload = {
                            code, name, sector, dateStr: selectedDate,
                            createdAt: new Date().toISOString()
                        };
                        for (const [key, value] of Object.entries(batchConditions)) {
                            if (value) payload[key] = true;
                        }
                        
                        await saveStockData(stockId, payload, true);
                        count++;
                    }
                }
                
                if (count > 0) resetUI(count);
                else showToast('æ²’æœ‰åµæ¸¬åˆ°æœ‰æ•ˆçš„ä»£è™Ÿ', 'error');
                return;
            }

            const batch = writeBatch(db);
            let count = 0;

            lines.forEach(codeRaw => {
                const match = codeRaw.match(/^(\d{3,6})/); 
                const code = match ? match[1] : codeRaw;
                
                if (code) {
                    let name = code;
                    let sector = '';
                    const info = getStockInfo(code);
                    if (info.name) {
                        name = info.name;
                        sector = info.sector || '';
                    }

                    const stockId = `${selectedDate}-${code}`;
                    const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'stocks', stockId);
                    
                    const payload = {
                        code, name, sector, dateStr: selectedDate,
                        createdAt: serverTimestamp()
                    };
                    for (const [key, value] of Object.entries(batchConditions)) {
                        if (value) payload[key] = true;
                    }

                    batch.set(ref, payload, { merge: true });
                    count++;
                }
            });

            if (count > 0) {
                try {
                    await batch.commit();
                    resetUI(count);
                } catch (e) {
                    console.error(e);
                    showToast('æ–°å¢å¤±æ•—', 'error');
                }
            } else {
                showToast('æ²’æœ‰åµæ¸¬åˆ°æœ‰æ•ˆçš„ä»£è™Ÿ', 'error');
            }
        });

        document.getElementById('openDictModal').addEventListener('click', () => {
            if (!user) { showToast('è«‹ç¨å€™ï¼Œè³‡æ–™åº«é€£ç·šä¸­...', 'info'); return; }
            document.getElementById('dictInput').value = '';
            document.getElementById('saveDictBtn').disabled = true;
            document.getElementById('dictPreviewBadge').textContent = 'é è¦½ï¼šå°‡åŒ¯å…¥ 0 ç­†';
            toggleModal('dictModal', true);
        });

        function updateDictCount() {
            const el = document.getElementById('dbCountDisplay');
            if (el) el.textContent = `è‡ªå®šç¾©è³‡æ–™åº«ï¼š${Object.keys(userDictionary).length} ç­†`;
        }

        const parseDictInput = (input) => {
            const lines = input.split(/\n/);
            const valid = [];
            lines.forEach(line => {
                const cleanLine = line.trim();
                if (!cleanLine) return;
                const codeMatch = cleanLine.match(/(\d{3,6})/);
                if (!codeMatch) return;
                const code = codeMatch[1];
                let rest = cleanLine.replace(code, '').trim();
                const parts = rest.split(/[\s,\t]+/).filter(Boolean);
                let name = '';
                let sector = '';
                if (parts.length > 0) {
                    name = parts[0];
                    if (parts.length > 1) {
                        sector = parts[1];
                    }
                }
                if (code && name) {
                    valid.push({ code, name, sector });
                }
            });
            return valid;
        };

        document.getElementById('dictInput').addEventListener('input', (e) => {
            const validEntries = parseDictInput(e.target.value);
            const badge = document.getElementById('dictPreviewBadge');
            if (badge) badge.textContent = `é è¦½ï¼šå°‡åŒ¯å…¥ ${validEntries.length} ç­†`;
            document.getElementById('saveDictBtn').disabled = validEntries.length === 0;
        });

        document.getElementById('saveDictBtn').addEventListener('click', async () => {
            if (!user) { showToast('è«‹ç¨å€™ï¼Œè³‡æ–™åº«é€£ç·šä¸­...', 'info'); return; }
            const input = document.getElementById('dictInput').value;
            const btn = document.getElementById('saveDictBtn');
            btn.textContent = 'è™•ç†ä¸­...';
            btn.disabled = true;

            const validEntries = parseDictInput(input);
            const CHUNK_SIZE = 450;
            let successCount = 0;
            
            // For Local Mode
            if (useLocalMode) {
                validEntries.forEach(entry => {
                    userDictionary[entry.code] = { name: entry.name, sector: entry.sector };
                });
                saveLocalDict();
                showToast(`æˆåŠŸåŒ¯å…¥ ${validEntries.length} ç­†æ¸…å–® (Local)`, 'success');
                toggleModal('dictModal', false);
                btn.textContent = 'å„²å­˜è‡ªå®šç¾©æ¸…å–®';
                btn.disabled = false;
                return;
            }

            try {
                for (let i = 0; i < validEntries.length; i += CHUNK_SIZE) {
                    const chunk = validEntries.slice(i, i + CHUNK_SIZE);
                    const batch = writeBatch(db);
                    chunk.forEach(entry => {
                        const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'stockDictionary', entry.code);
                        batch.set(ref, { code: entry.code, name: entry.name, sector: entry.sector });
                    });
                    await batch.commit();
                    successCount += chunk.length;
                }
                showToast(`æˆåŠŸåŒ¯å…¥ ${successCount} ç­†æ¸…å–®`, 'success');
                toggleModal('dictModal', false);
            } catch (e) {
                console.error(e);
                showToast('å„²å­˜å¤±æ•—', 'error');
            } finally {
                btn.textContent = 'å„²å­˜è‡ªå®šç¾©æ¸…å–®';
                btn.disabled = false;
            }
        });

        // --- Backup/Restore ---
        window.exportData = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ stocks, dictionary }));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", `stock_diary_${currentDate}.json`);
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        };

        window.importData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.stocks) stocks = data.stocks;
                    if (data.dictionary) Object.assign(dictionary, data.dictionary);
                    saveData();
                    localStorage.setItem('stock_diary_dict', JSON.stringify(dictionary));
                    showToast('è³‡æ–™é‚„åŸæˆåŠŸ', 'success');
                } catch(err) { showToast('æª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error'); }
            };
            reader.readAsText(file);
        };

        lucide.createIcons();
    </script>
</body>
</html>
